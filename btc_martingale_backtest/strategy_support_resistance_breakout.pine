// This work is licensed under a Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) https://creativecommons.org/licenses/by-nc-sa/4.0/
// Â© LuxAlgo

//@version=6
strategy("Support and Resistance Breakout Strategy", shorttitle="SR Breakout Strategy [LuxAlgo]", overlay=true, max_bars_back=1000, margin_long=100, margin_short=0)

// Input parameters
toggleBreaks = input.bool(true, title="Show Breaks")
leftBars = input.int(15, title="Left Bars")
rightBars = input.int(15, title="Right Bars")
volumeThresh = input.int(20, title="Volume Threshold")

// Pivot calculations
highUsePivot = ta.pivothigh(high, leftBars, rightBars)
lowUsePivot = ta.pivotlow(low, leftBars, rightBars)

// Plot support and resistance levels
r1 = plot(highUsePivot, color=highUsePivot != highUsePivot[1] ? na : color.red, linewidth=3, offset=-(rightBars+1), title="Resistance")
s1 = plot(lowUsePivot, color=lowUsePivot != lowUsePivot[1] ? na : color.blue, linewidth=3, offset=-(rightBars+1), title="Support")

// Volume calculation
short = ta.ema(volume, 5)
long = ta.ema(volume, 10)
osc = 100 * (short - long) / long

// Crossover signals (calculated once per bar for consistency)
crossoverHigh = ta.crossover(close, highUsePivot)
crossunderLow = ta.crossunder(close, lowUsePivot)

// Break detection with volume
plotshape(toggleBreaks and crossunderLow and not (open - close < high - open) and osc > volumeThresh, title="Break", text="B", style=shape.labeldown, location=location.abovebar, color=color.red, textcolor=color.white, transp=0, size=size.tiny)
plotshape(toggleBreaks and crossoverHigh and not (open - low > close - open) and osc > volumeThresh, title="Break", text="B", style=shape.labelup, location=location.belowbar, color=color.green, textcolor=color.white, transp=0, size=size.tiny)

// Bull/Bear wicks
plotshape(toggleBreaks and crossoverHigh and open - low > close - open, title="Break", text="Bull Wick", style=shape.labelup, location=location.belowbar, color=color.green, textcolor=color.white, transp=0, size=size.tiny)
plotshape(toggleBreaks and crossunderLow and open - close < high - open, title="Break", text="Bear Wick", style=shape.labeldown, location=location.abovebar, color=color.red, textcolor=color.white, transp=0, size=size.tiny)

// Strategy logic
// Check if close breaks above resistance
resistanceBreak = crossoverHigh

// Count candles above resistance after breakout
var int candlesAboveResistance = 0
var float breakoutLevel = na
var float entryPrice = na
var float stopLoss = na
var float takeProfit = na

if resistanceBreak
    candlesAboveResistance := 1
    breakoutLevel := highUsePivot
else if not na(breakoutLevel)
    // Check if current and previous 3 candles are above resistance
    if close > breakoutLevel and close[1] > breakoutLevel and close[2] > breakoutLevel and close[3] > breakoutLevel
        candlesAboveResistance := 4
    else if close > breakoutLevel and close[1] > breakoutLevel and close[2] > breakoutLevel
        candlesAboveResistance := 3
    else if close > breakoutLevel and close[1] > breakoutLevel
        candlesAboveResistance := 2
    else if close > breakoutLevel
        candlesAboveResistance := 1
    else
        candlesAboveResistance := 0
        breakoutLevel := na

// Entry condition: 4 candles above resistance
if candlesAboveResistance == 4 and strategy.position_size == 0
    entryPrice := close
    stopLoss := breakoutLevel
    takeProfit := entryPrice + (entryPrice - stopLoss) * 1.5
    strategy.entry("Long", strategy.long)

// Exit conditions
if strategy.position_size > 0
    strategy.exit("Exit", "Long", stop=stopLoss, limit=takeProfit)

// Plot entry, stop loss, and take profit levels
plot(entryPrice, color=color.green, style=plot.style_linebr, title="Entry Price", linewidth=2)
plot(stopLoss, color=color.red, style=plot.style_linebr, title="Stop Loss", linewidth=2)
plot(takeProfit, color=color.orange, style=plot.style_linebr, title="Take Profit", linewidth=2)

// Alert conditions
alertcondition(crossunderLow and osc > volumeThresh, title="Support Broken", message="Support Broken")
alertcondition(crossoverHigh and osc > volumeThresh, title="Resistance Broken", message="Resistance Broken")
